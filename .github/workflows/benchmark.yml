name: Benchmark

on:
  # Need pull_request_target so that forks can also run this workflow
  # https://github.com/thollander/actions-comment-pull-request/issues/237
  pull_request_target:
    branches:
      - main
    paths:
      - .github/workflows/benchmark.yml
      - crates/**/src/**
      - crates/**/Cargo.toml
      - "!crates/jarl-lsp/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Same repositories as ecosystem-check for consistency
  TEST_REPOS: |
    lrberge/stringmagic@87b187d40c745ea1d8496f071aee7229985da23c
    pola-rs/r-polars@055f891d977d6a8004fe8ab1bb5d47cfdd44872a
    Rdatatable/data.table@d7833cb3a0c36ab329fcfe5cc1523449663f898f
    ropensci/targets@d45243e1a239da467c6e96e0069ecb7368f78021
    rstudio/shiny@b6e9e9d216cd574cf8985d23772399f51ee4a4ac
    tidyverse/dplyr@384ff2c4af79a9bd9142d8bdab23efbcd52f275b
    tidyverse/ggplot2@bed8e32d45c7dc98afb783b409edac98854d41a7
    vincentarelbundock/marginaleffects@ffe5a4f5962a9ba51c3e68e1c55eea62887c25da
    wch/r-source@b5cf23a805f4305852f55c4148f2a302b06844b5

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current PR branch
        uses: actions/checkout@v4

      - name: Install hyperfine
        run: sudo apt install hyperfine

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          key: benchmark-pr

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Build jarl binary from PR
        run: cargo build --release --package jarl

      - name: Save PR binary path
        run: |
          cp target/release/jarl target/release/jarl-pr
          echo "PR_JARL=$(pwd)/target/release/jarl-pr" >> $GITHUB_ENV

      - name: Build jarl binary from main branch
        run: |
          git fetch origin main
          git checkout origin/main
          cargo build --release --package jarl

      - name: Save main binary path
        run: echo "MAIN_JARL=$(pwd)/target/release/jarl" >> $GITHUB_ENV

      - name: Clone all test repos
        run: |
          mkdir -p test-repos
          cd test-repos
          for repo in $TEST_REPOS; do
            repo_name=$(echo "$repo" | cut -d'@' -f1)
            commit_sha=$(echo "$repo" | cut -d'@' -f2)
            repo_dir=$(echo "$repo_name" | tr '/' '_')

            echo "Cloning $repo_name at $commit_sha..."
            git clone --depth 1 https://github.com/$repo_name.git $repo_dir
            (cd $repo_dir && git fetch --depth 1 origin $commit_sha && git checkout $commit_sha)
          done

      - name: Run hyperfine on all repos
        run: |
          mkdir -p results_bench
          cd test-repos
          for repo in $TEST_REPOS; do
            echo "Benchmarking repo $repo..."
            repo_name=$(echo "$repo" | cut -d'@' -f1)
            repo_dir=$(echo "$repo_name" | tr '/' '_')

            # Run main
            (cd "$repo_dir" && hyperfine --warmup 5 --min-runs 50 '$MAIN_JARL check .' --ignore-failure  --export-json ../../results_bench/${repo_dir}_main.json) || true

            # Run PR
            (cd "$repo_dir" && hyperfine --warmup 5 --min-runs 50 '$PR_JARL check .' --ignore-failure  --export-json ../../results_bench/${repo_dir}_pr.json) || true
          done

      - name: Upload all result JSONs
        uses: actions/upload-artifact@v4
        with:
          name: hyperfine-json-results
          path: results_bench/

      - name: Setup R to process benchmark results
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Install R dependencies
        run: |
          R -e "install.packages(c('data.table', 'jsonlite', 'pandoc', 'tinytable'))"

      - name: Process benchmark results
        run: |
          source(".github/scripts/process_bench_ci.R", echo = TRUE)
        shell: Rscript {0}

      - name: Upload results
        id: artifact-upload-step
        uses: actions/upload-artifact@v4
        with:
          name: bench-results
          path: .github/scripts/

      - name: Post comment on PR
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: benchmark.md
          comment-tag: benchmark-comment
